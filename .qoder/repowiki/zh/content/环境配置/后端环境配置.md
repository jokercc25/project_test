# 后端环境配置

<cite>
**本文档中引用的文件**  
- [application.properties](file://backend/src/main/resources/application.properties)
- [pom.xml](file://backend/pom.xml)
- [schema.sql](file://backend/src/main/resources/schema.sql)
- [test-data.sql](file://backend/src/main/resources/test-data.sql)
- [BatchSelectionApplication.java](file://backend/src/main/java/com/example/batchselection/BatchSelectionApplication.java)
</cite>

## 目录
1. [服务器配置](#服务器配置)
2. [数据源配置](#数据源配置)
3. [JPA配置](#jpa配置)
4. [SQL脚本初始化配置](#sql脚本初始化配置)
5. [日志配置](#日志配置)
6. [Jackson配置](#jackson配置)
7. [常见配置错误排查](#常见配置错误排查)

## 服务器配置

`application.properties` 文件中的服务器配置部分定义了应用的网络访问参数：

```properties
server.port=8080
server.servlet.context-path=/
```

- **server.port=8080**：指定Spring Boot应用监听的端口号为8080。这意味着应用将通过 `http://localhost:8080` 地址访问。若该端口被占用，可修改为其他可用端口（如8081、9090等）。
- **server.servlet.context-path=/**：设置应用的上下文路径。当前配置为根路径 `/`，表示所有API接口直接通过根路径访问。若设置为 `/api`，则所有接口需通过 `/api/xxx` 形式访问。

**Section sources**
- [application.properties](file://backend/src/main/resources/application.properties#L4-L5)

## 数据源配置

数据源配置定义了应用与MySQL数据库的连接方式：

```properties
spring.datasource.url=jdbc:mysql://localhost:3306/batch_selection?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai&allowPublicKeyRetrieval=true&createDatabaseIfNotExist=true
spring.datasource.username=root
spring.datasource.password=12345678
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver
```

### 数据库连接URL参数详解

`spring.datasource.url` 中包含多个关键参数：

- **jdbc:mysql://localhost:3306/batch_selection**：基础连接信息
  - `localhost`：数据库服务器地址（可改为IP或域名）
  - `3306`：MySQL默认端口
  - `batch_selection`：数据库名称

- **连接参数说明**：
  - `useUnicode=true`：启用Unicode字符集支持
  - `characterEncoding=utf8`：指定字符编码为UTF-8，确保中文等多字节字符正确存储
  - `useSSL=false`：禁用SSL连接（生产环境建议启用SSL）
  - `serverTimezone=Asia/Shanghai`：设置服务器时区为中国标准时间，避免时间字段时区转换问题
  - `allowPublicKeyRetrieval=true`：允许客户端从服务器获取公钥，解决某些MySQL 8.x版本的身份验证问题
  - `createDatabaseIfNotExist=true`：若数据库不存在则自动创建

### 用户名与密码

- `spring.datasource.username=root`：数据库登录用户名
- `spring.datasource.password=12345678`：数据库登录密码（生产环境应使用更安全的密码）

### 驱动类配置

`spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver` 指定使用MySQL Connector/J 8.x版本的驱动类。该驱动在 `pom.xml` 中已声明依赖：

```xml
<dependency>
    <groupId>mysql</groupId>
    <artifactId>mysql-connector-java</artifactId>
    <version>8.0.33</version>
</dependency>
```

**Section sources**
- [application.properties](file://backend/src/main/resources/application.properties#L8-L11)
- [pom.xml](file://backend/pom.xml#L42-L47)

## JPA配置

JPA（Java Persistence API）配置控制Hibernate的行为和数据库交互方式：

```properties
spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=true
spring.jpa.properties.hibernate.format_sql=true
spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.MySQL8Dialect
spring.jpa.defer-datasource-initialization=true
```

### ddl-auto=update 策略

`spring.jpa.hibernate.ddl-auto=update` 是JPA的数据库模式更新策略：

- **作用**：启动时自动根据实体类（Entity）结构更新数据库表结构
- **行为特点**：
  - 新增字段时：自动添加列
  - 修改字段类型时：尝试修改列类型
  - 删除字段时：不会删除数据库中的列（防止数据丢失）
- **适用场景**：开发和测试环境
- **生产环境建议**：应使用 `validate` 或 `none`，并通过数据库迁移工具（如Flyway、Liquibase）管理表结构变更

### SQL调试配置

- `spring.jpa.show-sql=true`：在控制台输出执行的SQL语句，便于调试
- `spring.jpa.properties.hibernate.format_sql=true`：格式化输出的SQL语句，提高可读性

### 方言配置

`spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.MySQL8Dialect` 指定使用MySQL 8.x的方言，确保生成的SQL语句兼容MySQL 8.x特性。

### 延迟初始化

`spring.jpa.defer-datasource-initialization=true` 确保数据源初始化在JPA实体映射之后进行，避免初始化顺序问题。

**Section sources**
- [application.properties](file://backend/src/main/resources/application.properties#L14-L18)
- [AppInfo.java](file://backend/src/main/java/com/example/batchselection/entity/AppInfo.java#L10-L60)
- [TaskInfo.java](file://backend/src/main/java/com/example/batchselection/entity/TaskInfo.java#L9-L52)

## SQL脚本初始化配置

该配置控制应用启动时的数据库初始化行为：

```properties
spring.sql.init.mode=always
spring.sql.init.data-locations=classpath:test-data.sql
spring.sql.init.continue-on-error=true
```

### 初始化模式

`spring.sql.init.mode=always` 表示每次应用启动时都执行初始化脚本。其他可选值包括：
- `embedded`：仅对嵌入式数据库执行初始化
- `never`：从不执行初始化
- `always`：总是执行初始化

### 数据脚本位置

`spring.sql.init.data-locations=classpath:test-data.sql` 指定初始化数据脚本的位置。`classpath:` 表示从类路径（resources目录）下查找文件。`test-data.sql` 文件包含测试数据的插入语句。

### 错误处理策略

`spring.sql.init.continue-on-error=true` 表示即使某个SQL语句执行失败，也继续执行后续语句。这在部分数据已存在时特别有用。

数据库表结构由 `schema.sql` 文件定义，包含 `app_info`（应用数据表）和 `task_info`（任务表）两个表。

**Section sources**
- [application.properties](file://backend/src/main/resources/application.properties#L21-L23)
- [schema.sql](file://backend/src/main/resources/schema.sql#L1-L38)
- [test-data.sql](file://backend/src/main/resources/test-data.sql#L1-L20)

## 日志配置

日志配置定义了应用的日志输出级别和格式：

```properties
logging.level.root=INFO
logging.level.com.example.batchselection=DEBUG
logging.pattern.console=%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n
```

- `logging.level.root=INFO`：设置根日志级别为INFO，记录重要信息
- `logging.level.com.example.batchselection=DEBUG`：将应用包的日志级别设为DEBUG，便于调试业务逻辑
- `logging.pattern.console`：定义控制台日志输出格式，包含时间、线程、日志级别、日志器名称和消息

**Section sources**
- [application.properties](file://backend/src/main/resources/application.properties#L26-L28)

## Jackson配置

Jackson配置控制JSON序列化和反序列化行为：

```properties
spring.jackson.time-zone=GMT+8
spring.jackson.date-format=yyyy-MM-dd HH:mm:ss
spring.jackson.serialization.write-dates-as-timestamps=false
```

- `spring.jackson.time-zone=GMT+8`：设置时区为东八区
- `spring.jackson.date-format=yyyy-MM-dd HH:mm:ss`：设置日期格式化模式
- `spring.jackson.serialization.write-dates-as-timestamps=false`：禁用时间戳格式，使用格式化日期字符串

**Section sources**
- [application.properties](file://backend/src/main/resources/application.properties#L31-L33)

## 常见配置错误排查

### 数据库连接失败

**可能原因**：
- MySQL服务未启动
- 数据库地址、端口、用户名或密码错误
- 防火墙阻止连接

**解决方案**：
1. 确认MySQL服务正在运行
2. 检查 `application.properties` 中的连接信息
3. 使用MySQL客户端工具测试连接

### 驱动类找不到

**错误信息**：`java.lang.ClassNotFoundException: com.mysql.cj.jdbc.Driver`

**解决方案**：
1. 确认 `pom.xml` 中包含MySQL驱动依赖
2. 执行 `mvn clean install` 重新下载依赖
3. 检查Maven本地仓库中驱动jar包是否完整

### 端口冲突

**错误信息**：`Web server failed to start. Port 8080 was already in use.`

**解决方案**：
1. 使用 `netstat -an | grep 8080`（Linux/Mac）或 `netstat -ano | findstr 8080`（Windows）查找占用端口的进程
2. 终止占用进程或修改 `server.port` 为其他可用端口

### 时区配置错误

**问题表现**：时间字段出现时区偏差

**解决方案**：
确保连接URL中包含 `serverTimezone=Asia/Shanghai` 参数，并与 `spring.jackson.time-zone` 保持一致。

**Section sources**
- [application.properties](file://backend/src/main/resources/application.properties#L8)
- [pom.xml](file://backend/pom.xml#L42-L47)
- [README.md](file://README.md#L118-L138)