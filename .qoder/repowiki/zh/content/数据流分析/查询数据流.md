# 查询数据流

<cite>
**Referenced Files in This Document**   
- [BatchSelectionPage.jsx](file://frontend/src/components/BatchSelectionPage.jsx)
- [index.js](file://frontend/src/api/index.js)
- [BatchSelectionController.java](file://backend/src/main/java/com/example/batchselection/controller/BatchSelectionController.java)
- [BatchSelectionServiceImpl.java](file://backend/src/main/java/com/example/batchselection/service/impl/BatchSelectionServiceImpl.java)
- [ApplicationResponseDTO.java](file://backend/src/main/java/com/example/batchselection/dto/ApplicationResponseDTO.java)
- [AppInfo.java](file://backend/src/main/java/com/example/batchselection/entity/AppInfo.java)
- [GroupInfoDTO.java](file://backend/src/main/java/com/example/batchselection/dto/GroupInfoDTO.java)
- [AppInfoRepository.java](file://backend/src/main/java/com/example/batchselection/repository/AppInfoRepository.java)
</cite>

## Table of Contents
1. [数据查询流程概述](#数据查询流程概述)
2. [前端数据加载机制](#前端数据加载机制)
3. [后端数据处理流程](#后端数据处理流程)
4. [数据格式转换与树形结构构建](#数据格式转换与树形结构构建)
5. [错误处理与状态管理](#错误处理与状态管理)
6. [数据流时序图](#数据流时序图)

## 数据查询流程概述

本系统实现了从前端页面加载到后端数据查询的完整数据流。当用户访问批量勾选信息管理页面时，前端组件在挂载后自动触发数据查询流程，通过REST API与后端服务交互，获取应用数据并进行展示。整个流程涉及前端状态管理、API调用、后端控制器处理、服务层业务逻辑和数据库查询等多个环节。

**Section sources**
- [BatchSelectionPage.jsx](file://frontend/src/components/BatchSelectionPage.jsx#L1-L351)
- [BatchSelectionController.java](file://backend/src/main/java/com/example/batchselection/controller/BatchSelectionController.java#L1-L64)

## 前端数据加载机制

前端数据加载流程始于`BatchSelectionPage.jsx`组件的挂载。组件使用React的`useEffect` Hook在组件挂载后自动调用`loadApplications`函数，启动数据查询过程。

```mermaid
sequenceDiagram
participant Component as BatchSelectionPage组件
participant API as API客户端
participant Backend as 后端服务
Component->>Component : 组件挂载
Component->>Component : useEffect触发
Component->>Component : 调用loadApplications()
Component->>API : getApplications()
API->>Backend : GET /api/applications
```

**Diagram sources**
- [BatchSelectionPage.jsx](file://frontend/src/components/BatchSelectionPage.jsx#L20-L22)
- [index.js](file://frontend/src/api/index.js#L24-L25)

**Section sources**
- [BatchSelectionPage.jsx](file://frontend/src/components/BatchSelectionPage.jsx#L19-L37)
- [index.js](file://frontend/src/api/index.js#L23-L25)

## 后端数据处理流程

后端数据处理流程由`BatchSelectionController`接收前端请求开始，通过服务层调用完成数据查询和转换。控制器接收到`GET /api/applications`请求后，委托`BatchSelectionService`服务获取数据。

```mermaid
sequenceDiagram
participant Controller as BatchSelectionController
participant Service as BatchSelectionService
participant Repository as AppInfoRepository
participant Database as 数据库
Controller->>Service : getAllApplications()
Service->>Repository : findAllOrderByAppNameAndGroupName()
Repository->>Database : 执行SQL查询
Database-->>Repository : 返回AppInfo列表
Repository-->>Service : AppInfo列表
Service->>Service : 按应用名分组
Service->>Service : 转换为DTO结构
Service-->>Controller : ApplicationResponseDTO列表
Controller-->>前端 : ApiResponse封装的响应
```

**Diagram sources**
- [BatchSelectionController.java](file://backend/src/main/java/com/example/batchselection/controller/BatchSelectionController.java#L33-L42)
- [BatchSelectionServiceImpl.java](file://backend/src/main/java/com/example/batchselection/service/impl/BatchSelectionServiceImpl.java#L35-L62)
- [AppInfoRepository.java](file://backend/src/main/java/com/example/batchselection/repository/AppInfoRepository.java#L18-L19)

**Section sources**
- [BatchSelectionController.java](file://backend/src/main/java/com/example/batchselection/controller/BatchSelectionController.java#L32-L42)
- [BatchSelectionServiceImpl.java](file://backend/src/main/java/com/example/batchselection/service/impl/BatchSelectionServiceImpl.java#L34-L62)
- [AppInfoRepository.java](file://backend/src/main/java/com/example/batchselection/repository/AppInfoRepository.java#L18-L19)

## 数据格式转换与树形结构构建

数据格式转换过程包含两个关键阶段：后端DTO转换和前端树形结构构建。

### 后端数据转换

后端服务从数据库查询`AppInfo`实体列表后，首先按应用名进行分组，然后将每个应用下的分组信息转换为`GroupInfoDTO`对象，最终构建成`ApplicationResponseDTO`列表。这种分层数据结构便于前端进行树形展示。

```mermaid
classDiagram
class ApplicationResponseDTO {
+String appName
+GroupInfoDTO[] groups
}
class GroupInfoDTO {
+Long id
+String groupName
+String grayGroupName
+String idc
+String zone
+String spec
+Integer diskSize
+Integer podCount
}
class AppInfo {
+Long id
+String appName
+String groupName
+String grayGroupName
+String idc
+String zone
+String spec
+Integer diskSize
+Integer podCount
}
ApplicationResponseDTO --> GroupInfoDTO : "包含"
AppInfo --> GroupInfoDTO : "转换为"
```

**Diagram sources**
- [ApplicationResponseDTO.java](file://backend/src/main/java/com/example/batchselection/dto/ApplicationResponseDTO.java#L10-L13)
- [GroupInfoDTO.java](file://backend/src/main/java/com/example/batchselection/dto/GroupInfoDTO.java#L9-L19)
- [AppInfo.java](file://backend/src/main/java/com/example/batchselection/entity/AppInfo.java#L15-L61)
- [BatchSelectionServiceImpl.java](file://backend/src/main/java/com/example/batchselection/service/impl/BatchSelectionServiceImpl.java#L98-L109)

### 前端树形结构构建

前端接收到`ApplicationResponseDTO`列表后，使用`useMemo` Hook将扁平数据转换为树形结构，以适应Ant Design Table的树形展示需求。`treeData`依赖`applications`和`editedData`两个状态，当它们发生变化时自动重新计算。

```mermaid
flowchart TD
Start([开始构建树形结构]) --> Init["初始化空数据数组"]
Init --> LoopApp["遍历每个应用"]
LoopApp --> CreateAppNode["创建应用级节点"]
CreateAppNode --> LoopGroup["遍历应用下的分组"]
LoopGroup --> CreateGroupNode["创建分组级节点"]
CreateGroupNode --> MergeEdit["合并编辑数据"]
MergeEdit --> AddToApp["添加到应用节点的children"]
AddToApp --> CheckGroupEnd{"分组遍历完成?"}
CheckGroupEnd --> |否| LoopGroup
CheckGroupEnd --> |是| AddToData["添加应用节点到数据数组"]
AddToData --> CheckAppEnd{"应用遍历完成?"}
CheckAppEnd --> |否| LoopApp
CheckAppEnd --> |是| Return["返回树形数据"]
Return --> End([结束])
```

**Diagram sources**
- [BatchSelectionPage.jsx](file://frontend/src/components/BatchSelectionPage.jsx#L40-L74)

**Section sources**
- [BatchSelectionPage.jsx](file://frontend/src/components/BatchSelectionPage.jsx#L40-L74)
- [BatchSelectionPage.jsx](file://frontend/src/components/BatchSelectionPage.jsx#L77-L85)

## 错误处理与状态管理

系统实现了完善的错误处理机制和加载状态管理，确保用户体验的流畅性和系统的健壮性。

### 加载状态管理

前端通过`loading`状态变量控制加载指示器的显示。在数据查询开始时设置`setLoading(true)`，在`finally`块中设置`setLoading(false)`，确保无论请求成功或失败都能正确关闭加载状态。

### 错误处理机制

系统采用分层错误处理策略：
- **前端错误处理**：使用Ant Design的`message.error`方法显示错误提示，区分API响应错误和网络异常
- **后端错误处理**：在控制器层捕获异常，记录日志并返回标准化的错误响应

```mermaid
flowchart TD
Start([loadApplications函数]) --> SetLoading["setLoading(true)"]
SetLoading --> Try["try块"]
Try --> CallAPI["调用getApplications()"]
CallAPI --> CheckResponse{"响应code是否为200?"}
CheckResponse --> |是| SetData["setApplications(response.data)"]
CheckResponse --> |否| ShowError1["message.error(response.message)"]
ShowError1 --> Finally["finally块"]
CallAPI --> Exception["捕获异常"]
Exception --> ShowError2["message.error('加载数据失败: ' + error.message)"]
ShowError2 --> Finally
SetData --> Finally
Finally --> ClearLoading["setLoading(false)"]
ClearLoading --> End([函数结束])
```

**Diagram sources**
- [BatchSelectionPage.jsx](file://frontend/src/components/BatchSelectionPage.jsx#L24-L37)

**Section sources**
- [BatchSelectionPage.jsx](file://frontend/src/components/BatchSelectionPage.jsx#L30-L34)
- [BatchSelectionController.java](file://backend/src/main/java/com/example/batchselection/controller/BatchSelectionController.java#L39-L41)

## 数据流时序图

以下时序图完整展示了从前端组件挂载到数据展示的整个数据流过程：

```mermaid
sequenceDiagram
participant Frontend as 前端组件
participant API as API客户端
participant Controller as BatchSelectionController
participant Service as BatchSelectionService
participant Repository as AppInfoRepository
participant Database as 数据库
Frontend->>Frontend : 组件挂载
Frontend->>Frontend : useEffect触发
Frontend->>Frontend : 调用loadApplications()
Frontend->>API : getApplications()
API->>Controller : GET /api/applications
Controller->>Service : getAllApplications()
Service->>Repository : findAllOrderByAppNameAndGroupName()
Repository->>Database : 执行SQL查询
Database-->>Repository : 返回AppInfo列表
Repository-->>Service : AppInfo列表
Service->>Service : 按应用名分组
Service->>Service : 转换为ApplicationResponseDTO
Service-->>Controller : ApplicationResponseDTO列表
Controller-->>API : ApiResponse封装的响应
API-->>Frontend : 响应数据
Frontend->>Frontend : 检查响应code
alt 响应成功
Frontend->>Frontend : setApplications(data)
Frontend->>Frontend : treeData重新计算
Frontend->>Frontend : 更新表格展示
else 响应失败
Frontend->>Frontend : message.error提示
end
Frontend->>Frontend : setLoading(false)
```

**Diagram sources**
- [BatchSelectionPage.jsx](file://frontend/src/components/BatchSelectionPage.jsx#L19-L37)
- [index.js](file://frontend/src/api/index.js#L24-L25)
- [BatchSelectionController.java](file://backend/src/main/java/com/example/batchselection/controller/BatchSelectionController.java#L33-L42)
- [BatchSelectionServiceImpl.java](file://backend/src/main/java/com/example/batchselection/service/impl/BatchSelectionServiceImpl.java#L35-L62)
- [AppInfoRepository.java](file://backend/src/main/java/com/example/batchselection/repository/AppInfoRepository.java#L18-L19)

**Section sources**
- [BatchSelectionPage.jsx](file://frontend/src/components/BatchSelectionPage.jsx#L1-L351)
- [index.js](file://frontend/src/api/index.js#L1-L40)
- [BatchSelectionController.java](file://backend/src/main/java/com/example/batchselection/controller/BatchSelectionController.java#L1-L64)
- [BatchSelectionServiceImpl.java](file://backend/src/main/java/com/example/batchselection/service/impl/BatchSelectionServiceImpl.java#L1-L128)