# 调试技巧

<cite>
**本文档中引用的文件**  
- [BatchSelectionController.java](file://backend/src/main/java/com/example/batchselection/controller/BatchSelectionController.java)
- [application.properties](file://backend/src/main/resources/application.properties)
- [BatchSelectionPage.jsx](file://frontend/src/components/BatchSelectionPage.jsx)
- [EditableCell.jsx](file://frontend/src/components/EditableCell.jsx)
- [index.js](file://frontend/src/api/index.js)
- [BatchSelectionServiceImpl.java](file://backend/src/main/java/com/example/batchselection/service/impl/BatchSelectionServiceImpl.java)
- [TaskInfoRepository.java](file://backend/src/main/java/com/example/batchselection/repository/TaskInfoRepository.java)
</cite>

## 目录
1. [后端调试方法](#后端调试方法)
2. [前端调试方法](#前端调试方法)
3. [接口测试与验证](#接口测试与验证)

## 后端调试方法

在后端开发过程中，可通过以下方式对关键流程进行调试，确保请求处理、服务调用和数据库事务的正确性。

### 设置断点并使用IDE调试

在 `BatchSelectionController.java` 中设置断点，使用 IntelliJ IDEA 等支持 Java 调试的 IDE 进行调试：

- 在 `getApplications()` 方法的第35行（`log.info("收到查询应用数据请求");`）设置断点，用于跟踪 `/api/applications` 请求的进入与参数解析过程。
- 在 `submitTasks()` 方法的第51行（`log.info("收到批量提交任务请求，任务数量: {}", request.getTasks().size());`）设置断点，观察 `BatchTaskSubmitRequest` 请求体的反序列化结果及参数校验流程。
- 调试时可逐步进入 `BatchSelectionServiceImpl` 的 `submitTasks` 方法，查看任务数据转换为 `TaskInfo` 实体的过程，并验证数据库事务是否正常提交。

**Section sources**
- [BatchSelectionController.java](file://backend/src/main/java/com/example/batchselection/controller/BatchSelectionController.java#L35-L62)
- [BatchSelectionServiceImpl.java](file://backend/src/main/java/com/example/batchselection/service/impl/BatchSelectionServiceImpl.java#L67-L94)

### 启用DEBUG日志观察数据访问细节

通过 `application.properties` 文件中配置的日志级别，启用 DEBUG 模式以观察服务层和数据访问层的详细执行过程：

```properties
logging.level.com.example.batchselection=DEBUG
```

此配置将使 `@Slf4j` 注解记录的 `DEBUG` 级别日志生效，例如：
- `getAllApplications()` 方法中的 `log.info("开始查询所有应用数据");`
- `submitTasks()` 方法中的 `log.info("任务提交成功，生成任务ID: {}", taskIds);`

结合 Spring Data JPA 的 `spring.jpa.show-sql=true` 配置，可在控制台直接查看执行的 SQL 语句，便于验证数据库读写行为。

**Section sources**
- [application.properties](file://backend/src/main/resources/application.properties#L27)
- [BatchSelectionServiceImpl.java](file://backend/src/main/java/com/example/batchselection/service/impl/BatchSelectionServiceImpl.java#L36-L62)

## 前端调试方法

前端调试主要依赖浏览器开发者工具和代码级日志输出，用于验证组件状态、用户交互和API通信。

### 使用浏览器开发者工具监控网络请求

打开浏览器开发者工具（F12），切换至 **Network（网络）** 面板，执行以下操作：

- 刷新页面时观察 `/api/applications` 的 GET 请求：
  - 查看请求是否成功（状态码 200）
  - 检查响应体结构是否符合 `ApiResponse<List<ApplicationResponseDTO>>` 格式
- 点击“提交”按钮后，监控 `/api/tasks/submit` 的 POST 请求：
  - 验证请求体格式是否为 `{ tasks: [...] }`
  - 确认每个任务对象包含 `appName`, `groupName`, `idc`, `zone`, `spec`, `diskSize`, `podCount` 等字段
  - 检查响应是否返回生成的任务ID列表

**Section sources**
- [index.js](file://frontend/src/api/index.js#L32-L34)
- [BatchSelectionPage.jsx](file://frontend/src/components/BatchSelectionPage.jsx#L290-L292)

### 使用 console.log 和 React DevTools 检查组件状态

在 `BatchSelectionPage.jsx` 中，可通过以下方式调试组件状态：

- 在 `useEffect` 或 `handleSubmit` 中添加 `console.log(selectedRowKeys)`，观察勾选行键值的变化。
- 使用 `console.log(editedData)` 查看用户编辑后的数据是否正确合并到状态中。
- 利用 React DevTools 浏览组件树，检查 `BatchSelectionPage` 的 `state` 是否随用户操作正确更新，特别是 `selectedRowKeys` 和 `editedData` 的变化。

```javascript
const handleSubmit = async () => {
  console.log('当前选中行:', selectedRowKeys);
  console.log('当前编辑数据:', editedData);
  // ...
};
```

**Section sources**
- [BatchSelectionPage.jsx](file://frontend/src/components/BatchSelectionPage.jsx#L16-L18)
- [BatchSelectionPage.jsx](file://frontend/src/components/BatchSelectionPage.jsx#L251-L302)

### 调试 EditableCell 的 onBlur 事件逻辑

`EditableCell.jsx` 组件通过 `onBlur` 事件处理编辑完成后的值更新：

- 当用户在可编辑单元格中输入内容并失焦时，触发 `handleSave()` 方法。
- `handleSave` 会先校验输入值（如数字类型需为正整数），然后调用父组件传入的 `onChange` 回调函数更新状态。
- 可在 `handleSave` 方法中添加 `console.log`，观察 `tempValue` 和 `currentValue` 的变化，确保值更新逻辑正确。

```javascript
const handleSave = () => {
  console.log('保存值:', tempValue, '原值:', currentValue);
  // ...
};
```

**Section sources**
- [EditableCell.jsx](file://frontend/src/components/EditableCell.jsx#L27-L43)
- [BatchSelectionPage.jsx](file://frontend/src/components/BatchSelectionPage.jsx#L78-L86)

## 接口测试与验证

### 使用 Postman 手动构造 POST 请求

为独立验证后端接口功能，可使用 Postman 手动发送请求：

1. **请求地址**：`http://localhost:8080/api/tasks/submit`
2. **请求方法**：`POST`
3. **Headers**：
   - `Content-Type: application/json`
4. **Body（raw JSON）**：
```json
{
  "tasks": [
    {
      "appName": "test-app",
      "groupName": "group-1",
      "grayGroupName": "gray-1",
      "idc": "idc-a",
      "zone": "zone-1",
      "spec": "small",
      "diskSize": 100,
      "podCount": 3
    }
  ]
}
```

### 验证数据库写入结果

请求成功后，可通过以下方式验证数据是否正确写入数据库：

- 查询 `task_info` 表，确认新记录的 `app_name`, `group_name`, `idc` 等字段与请求一致。
- 检查返回的 `taskIds` 是否与数据库生成的主键匹配。
- 若使用 H2 或 MySQL，可通过数据库客户端执行 `SELECT * FROM task_info ORDER BY created_at DESC LIMIT 1;` 快速验证最新写入记录。

**Section sources**
- [TaskInfoRepository.java](file://backend/src/main/java/com/example/batchselection/repository/TaskInfoRepository.java#L11)
- [BatchSelectionServiceImpl.java](file://backend/src/main/java/com/example/batchselection/service/impl/BatchSelectionServiceImpl.java#L84-L89)